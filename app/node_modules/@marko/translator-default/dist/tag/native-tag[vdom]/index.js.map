{"version":3,"sources":["../../../src/tag/native-tag[vdom]/index.js"],"names":["SIMPLE_ATTRS","MAYBE_SVG","a","script","style","title","tagArguments","path","isStatic","hub","file","node","parent","name","key","body","handlers","tagProperties","runtimeFlags","get","forEach","attr","confident","computed","remove","set","t","stringLiteral","attrsObj","isNullLiteral","isObjectExpression","properties","some","isSpreadElement","FLAGS","SPREAD_ATTRS","callExpression","writeArgs","nullLiteral","identifier","numericLiteral","length","preserveAttrs","push","objectProperty","arrayExpression","map","Object","entries","eventName","arguments","args","once","delegateArgs","booleanLiteral","slice","memberExpression","_componentDefIdentifier","every","n","isPropertyName","HAS_SIMPLE_ATTRS","tagDef","htmlType","IS_CUSTOM_ELEMENT","isMarkoTag","IS_SVG","IS_TEXTAREA","objectExpression","isNullable","isEmpty","writeStartNode","ifStatement","expressionStatement","replaceWith","writeEndNode","needsBlock","childNode","isVariableDeclaration","kind","replaceWithMultiple","concat","blockStatement","names","isStringLiteral","includes","value","isIdentifier"],"mappings":"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","sourcesContent":["import { types as t } from \"@marko/compiler\";\nimport write from \"../../util/vdom-out-write\";\nimport * as FLAGS from \"../../util/runtime-flags\";\nimport { getAttrs, evaluateAttr } from \"../util\";\nimport {\n  getTagDef,\n  normalizeTemplateString,\n  importDefault\n} from \"@marko/babel-utils\";\nimport withPreviousLocation from \"../../util/with-previous-location\";\n\nconst SIMPLE_ATTRS = [\"id\", \"class\", \"style\"];\nconst MAYBE_SVG = {\n  a: true,\n  script: true,\n  style: true,\n  title: true\n};\n\nexport function tagArguments(path, isStatic) {\n  const {\n    hub: { file },\n    node,\n    parent\n  } = path;\n  const {\n    name,\n    key,\n    body: { body },\n    handlers\n  } = node;\n  const tagProperties = [];\n  let runtimeFlags = 0;\n\n  path.get(\"attributes\").forEach(attr => {\n    const { confident, computed } = evaluateAttr(attr);\n\n    if (confident) {\n      if (computed == null || computed === false) {\n        attr.remove();\n      } else {\n        attr.set(\"value\", t.stringLiteral(computed));\n      }\n    }\n  });\n\n  let attrsObj = getAttrs(path, true, true);\n\n  if (!t.isNullLiteral(attrsObj)) {\n    if (\n      !t.isObjectExpression(attrsObj) ||\n      attrsObj.properties.some(t.isSpreadElement)\n    ) {\n      runtimeFlags |= FLAGS.SPREAD_ATTRS;\n      attrsObj = t.callExpression(\n        importDefault(\n          file,\n          \"marko/src/runtime/vdom/helpers/attrs\",\n          \"marko_attrs\"\n        ),\n        [attrsObj]\n      );\n    }\n  }\n\n  const writeArgs = [\n    name,\n    attrsObj,\n    !key && isStatic ? t.nullLiteral() : key,\n    isStatic ? t.nullLiteral() : t.identifier(\"component\"),\n    isStatic\n      ? t.numericLiteral(body.length)\n      : body.length\n      ? t.nullLiteral()\n      : t.numericLiteral(0)\n  ];\n\n  if (node.preserveAttrs) {\n    tagProperties.push(\n      t.objectProperty(\n        t.identifier(\"pa\"),\n        t.arrayExpression(node.preserveAttrs.map(name => t.stringLiteral(name)))\n      )\n    );\n  }\n\n  if (handlers) {\n    Object.entries(handlers).forEach(\n      ([eventName, { arguments: args, once }]) => {\n        const delegateArgs = [t.stringLiteral(eventName), args[0]];\n\n        // TODO: look into only sending this if once is true.\n        delegateArgs.push(t.booleanLiteral(once));\n\n        if (args.length > 1) {\n          delegateArgs.push(t.arrayExpression(args.slice(1)));\n        }\n\n        // TODO: why do we output eventName twice.\n        tagProperties.push(\n          t.objectProperty(\n            t.stringLiteral(`on${eventName}`),\n            t.callExpression(\n              t.memberExpression(\n                file._componentDefIdentifier,\n                t.identifier(\"d\")\n              ),\n              delegateArgs\n            )\n          )\n        );\n      }\n    );\n  }\n\n  if (\n    t.isObjectExpression(attrsObj) &&\n    attrsObj.properties.every(n => isPropertyName(n, SIMPLE_ATTRS)) &&\n    !node.preserveAttrs\n  ) {\n    runtimeFlags |= FLAGS.HAS_SIMPLE_ATTRS;\n  }\n\n  const tagDef = getTagDef(path);\n\n  if (tagDef) {\n    const { htmlType, name } = tagDef;\n    if (htmlType === \"custom-element\") {\n      runtimeFlags |= FLAGS.IS_CUSTOM_ELEMENT;\n    } else if (\n      htmlType === \"svg\" ||\n      (MAYBE_SVG[name] &&\n        t.isMarkoTag(parent) &&\n        parent.tagDef &&\n        parent.tagDef.htmlType === \"svg\")\n    ) {\n      runtimeFlags |= FLAGS.IS_SVG;\n    } else if (name === \"textarea\") {\n      runtimeFlags |= FLAGS.IS_TEXTAREA;\n    }\n  }\n\n  writeArgs.push(t.numericLiteral(runtimeFlags));\n\n  if (tagProperties.length) {\n    writeArgs.push(t.objectExpression(tagProperties));\n  }\n  return writeArgs;\n}\n\n/**\n * Translates the html streaming version of a standard html element.\n */\nexport default function (path, isNullable) {\n  const { node } = path;\n  const {\n    name,\n    key,\n    body: { body }\n  } = node;\n\n  const isEmpty = !body.length;\n  const writeArgs = tagArguments(path, false);\n  let writeStartNode = withPreviousLocation(\n    write(isEmpty ? \"e\" : \"be\", ...writeArgs),\n    node.name\n  );\n\n  if (isNullable) {\n    writeStartNode = t.ifStatement(\n      name,\n      writeStartNode,\n      t.expressionStatement(\n        t.callExpression(\n          t.memberExpression(t.identifier(\"out\"), t.identifier(\"bf\")),\n          [normalizeTemplateString`f_${key}`, t.identifier(\"component\")]\n        )\n      )\n    );\n  }\n\n  if (isEmpty) {\n    path.replaceWith(writeStartNode);\n    return;\n  }\n\n  let writeEndNode = write(\"ee\");\n  if (isNullable) {\n    writeEndNode = t.ifStatement(\n      name,\n      writeEndNode,\n      t.expressionStatement(\n        t.callExpression(\n          t.memberExpression(t.identifier(\"out\"), t.identifier(\"ef\")),\n          []\n        )\n      )\n    );\n  }\n\n  let needsBlock;\n  for (const childNode of body) {\n    if (t.isVariableDeclaration(childNode)) {\n      if (childNode.kind === \"const\" || childNode.kind === \"let\") {\n        needsBlock = true;\n        break;\n      }\n    }\n  }\n\n  path.replaceWithMultiple(\n    [writeStartNode]\n      .concat(needsBlock ? t.blockStatement(body) : body)\n      .concat(writeEndNode)\n  );\n}\n\nfunction isPropertyName({ key }, names) {\n  if (t.isStringLiteral(key)) {\n    return names.includes(key.value);\n  } else if (t.isIdentifier(key)) {\n    return names.includes(key.name);\n  }\n}\n"],"file":"index.js"}