{"version":3,"sources":["../../src/babel-plugin/index.js"],"names":["SOURCE_FILES","WeakMap","api","markoOpts","assertVersion","translator","output","optimize","undefined","cache","using","shouldOptimize","translate","Error","resolveVirtualDependency","name","parserOverride","code","jsParseOptions","prevFS","curFS","fileSystem","file","getMarkoFile","finalAst","t","cloneDeep","ast","set","pre","metadata","sourceFile","get","marko","shallowClone","buildCodeFrameError","buildError","hub","MarkoFile","prototype","bind","___taglibLookup","___getMarkoFile","traverseAll","watchFiles","filter","unique","compileCache","Map","sourceFileName","isSource","isMigrate","canCache","id","contentHash","update","digest","cacheKey","cached","watchFile","mtime","Infinity","statSync","time","taglibLookup","path","dirname","type","program","sourceType","body","directives","meta","macros","deps","tags","rootMigrators","migrate","rootTransformers","transform","start","end","length","loc","line","column","scope","crawl","taglibsById","migrators","migrator","push","hook","default","transformers","transformer","taglibId","filePath","endsWith","analyze","Date","now","data","clone","key","v","Ctor","constructor","Array","Object","Set","RegExp","mergeVisitors","all","isArray","visitors","merge","explode","Program","mergedVisitors","state","enter","_call","traverse","exit","item","i","list","indexOf"],"mappings":"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","sourcesContent":["import path from \"path\";\nimport { createHash } from \"crypto\";\nimport * as t from \"../babel-types\";\nimport { getLoc, getTemplateId } from \"@marko/babel-utils\";\nimport { visitors } from \"@babel/traverse\";\nimport { buildLookup } from \"../taglib\";\nimport { parseMarko } from \"./parser\";\nimport { visitor as migrate } from \"./plugins/migrate\";\nimport { visitor as transform } from \"./plugins/transform\";\nimport { MarkoFile } from \"./file\";\nimport { curFS, setFS } from \"../taglib/fs\";\nimport tryLoadTranslator from \"../util/try-load-translator\";\nimport shouldOptimize from \"../util/should-optimize\";\n\nconst SOURCE_FILES = new WeakMap();\n\nexport default (api, markoOpts) => {\n  api.assertVersion(7);\n  const translator = (markoOpts.translator = tryLoadTranslator(\n    markoOpts.translator\n  ));\n  markoOpts.output = markoOpts.output || \"html\";\n\n  if (markoOpts.optimize === undefined) {\n    api.cache.using(shouldOptimize);\n    markoOpts.optimize = shouldOptimize();\n  }\n\n  if (!translator || !translator.translate) {\n    throw new Error(\n      \"@marko/compiler: translator must provide a translate visitor object\"\n    );\n  }\n\n  if (\n    markoOpts.output === \"hydrate\" &&\n    typeof markoOpts.resolveVirtualDependency !== \"function\"\n  ) {\n    throw new Error(\n      `@marko/compiler: the \"resolveVirtualDependency\" option must be supplied when output is \"hydrate\".`\n    );\n  }\n\n  return {\n    name: \"marko\",\n    parserOverride(code, jsParseOptions) {\n      let prevFS = curFS;\n      setFS(markoOpts.fileSystem);\n      try {\n        const file = getMarkoFile(code, jsParseOptions, markoOpts);\n        const finalAst = t.cloneDeep(file.ast);\n        SOURCE_FILES.set(finalAst, file);\n        return finalAst;\n      } finally {\n        setFS(prevFS);\n      }\n    },\n    pre(file) {\n      let prevFS = curFS;\n      setFS(markoOpts.fileSystem);\n      try {\n        if (markoOpts.output === \"source\" || markoOpts.output === \"migrate\") {\n          return file;\n        }\n\n        const { ast, metadata } = file;\n        const sourceFile = SOURCE_FILES.get(ast);\n        metadata.marko = shallowClone(sourceFile.metadata.marko);\n\n        const { buildCodeFrameError } = file;\n        const { buildError } = file.hub;\n        file.buildCodeFrameError = MarkoFile.prototype.buildCodeFrameError;\n        file.hub.buildError = file.buildCodeFrameError.bind(file);\n        file.markoOpts = markoOpts;\n        file.___taglibLookup = sourceFile.___taglibLookup;\n        file.___getMarkoFile = getMarkoFile;\n        traverseAll(file, translator.translate);\n        file.buildCodeFrameError = buildCodeFrameError;\n        file.hub.buildError = buildError;\n        file.markoOpts = file.___taglibLookup = file.___getMarkoFile = undefined;\n\n        metadata.marko.watchFiles = metadata.marko.watchFiles.filter(unique);\n      } finally {\n        setFS(prevFS);\n      }\n    }\n  };\n};\n\nexport function getMarkoFile(code, jsParseOptions, markoOpts) {\n  const { translator } = markoOpts;\n  let compileCache = markoOpts.cache.get(translator);\n\n  if (!compileCache) {\n    markoOpts.cache.set(translator, (compileCache = new Map()));\n  }\n\n  const { sourceFileName } = jsParseOptions;\n  const isSource = markoOpts.output === \"source\";\n  const isMigrate = markoOpts.output === \"migrate\";\n  const canCache = !(isSource || isMigrate);\n  const id = getTemplateId(markoOpts.optimize, sourceFileName);\n  const contentHash = canCache && createHash(\"MD5\").update(code).digest(\"hex\");\n  const cacheKey = canCache && createHash(\"MD5\").update(id).digest(\"hex\");\n\n  let cached = canCache && compileCache.get(cacheKey);\n\n  if (cached) {\n    if (cached.contentHash !== contentHash) {\n      // File content changed, invalidate the cache.\n      cached = undefined;\n    } else {\n      for (const watchFile of cached.file.metadata.marko.watchFiles) {\n        let mtime = Infinity;\n        try {\n          mtime = markoOpts.fileSystem.statSync(watchFile).mtime;\n          // eslint-disable-next-line no-empty\n        } catch {}\n\n        if (mtime > cached.time) {\n          // Some dependency changed, invalidate the cache.\n          cached = undefined;\n          break;\n        }\n      }\n    }\n  }\n\n  if (cached) {\n    return cached.file;\n  }\n\n  const taglibLookup = buildLookup(path.dirname(sourceFileName), translator);\n\n  const file = new MarkoFile(jsParseOptions, {\n    code,\n    ast: {\n      type: \"File\",\n      program: {\n        type: \"Program\",\n        sourceType: \"module\",\n        body: [],\n        directives: []\n      }\n    }\n  });\n\n  const meta = (file.metadata.marko = {\n    id,\n    macros: {},\n    deps: [],\n    tags: [],\n    watchFiles: []\n  });\n\n  const rootMigrators = [migrate];\n  const rootTransformers = [transform];\n\n  file.markoOpts = markoOpts;\n  file.___taglibLookup = taglibLookup;\n  file.___getMarkoFile = getMarkoFile;\n\n  file.ast.start = file.ast.program.start = 0;\n  file.ast.end = file.ast.program.end = code.length - 1;\n  file.ast.loc = file.ast.program.loc = {\n    start: { line: 0, column: 0 },\n    end: getLoc(file, file.ast.end)\n  };\n\n  parseMarko(file);\n\n  if (isSource) {\n    return file;\n  }\n\n  file.path.scope.crawl(); // Initialize bindings.\n\n  for (const id in taglibLookup.taglibsById) {\n    const { migrators } = taglibLookup.taglibsById[id];\n    for (const migrator of migrators) {\n      if (migrator.path) {\n        meta.watchFiles.push(migrator.path);\n      }\n      rootMigrators.push(migrator.hook.default || migrator.hook);\n    }\n  }\n\n  traverseAll(file, rootMigrators);\n\n  if (isMigrate) {\n    return file;\n  }\n\n  for (const id in taglibLookup.taglibsById) {\n    const { transformers } = taglibLookup.taglibsById[id];\n    for (const transformer of transformers) {\n      if (transformer.path) {\n        meta.watchFiles.push(transformer.path);\n      }\n      rootTransformers.push(transformer.hook.default || transformer.hook);\n    }\n  }\n\n  traverseAll(file, rootTransformers);\n\n  for (const taglibId in taglibLookup.taglibsById) {\n    const { filePath } = taglibLookup.taglibsById[taglibId];\n\n    if (\n      filePath[filePath.length - 5] === \".\" &&\n      filePath.endsWith(\"marko.json\")\n    ) {\n      meta.watchFiles.push(filePath);\n    }\n  }\n\n  if (translator.analyze) {\n    traverseAll(file, translator.analyze);\n  }\n\n  compileCache.set(cacheKey, {\n    time: Date.now(),\n    file,\n    contentHash\n  });\n\n  return file;\n}\n\nfunction shallowClone(data) {\n  const clone = {};\n\n  for (const key in data) {\n    const v = data[key];\n\n    if (v !== undefined) {\n      if (v === null || typeof v !== \"object\") {\n        clone[key] = v;\n      } else {\n        const Ctor = v.constructor;\n\n        switch (Ctor) {\n          case Array:\n            clone[key] = [...v];\n            break;\n          case Object:\n          case null:\n            clone[key] = { ...v };\n            break;\n          case Map:\n          case Set:\n          case Date:\n          case RegExp:\n            clone[key] = new Ctor(v);\n            break;\n\n          default:\n            throw new Error(`Unsupported metadata type of ${Ctor.name}`);\n        }\n      }\n    }\n  }\n\n  return clone;\n}\n\nfunction mergeVisitors(all) {\n  if (Array.isArray(all)) {\n    if (all.length === 1) {\n      all = all[0];\n    } else {\n      return visitors.merge(all);\n    }\n  }\n\n  return visitors.explode(all);\n}\n\nfunction traverseAll(file, visitors) {\n  const program = file.path;\n  const { Program, ...mergedVisitors } = mergeVisitors(visitors);\n  program.state = {};\n\n  // Traverse only walks into children by default\n  // This manually traverses into the Program node as well.\n  if (!(Program && Program.enter && program._call(Program.enter))) {\n    program.traverse(mergedVisitors, program.state);\n\n    if (Program && Program.exit) {\n      program._call(Program.exit);\n    }\n  }\n}\n\nfunction unique(item, i, list) {\n  return list.indexOf(item) === i;\n}\n"],"file":"index.js"}